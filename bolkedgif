#!/bin/sh
# http://bolknote.ru 2012 Evgeny Stepanischev

[ -r "$1" ] && [ -n "$2" ] && file -b "$1" | grep -Fq GIF
if [ $? -eq 1 ]; then
    echo –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    echo '  '$0 –∏—Å—Ö–æ–¥–Ω—ã–π.gif —Å–∂–∞—Ç—ã–π.gif-gz
    exit 0
fi

# –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
TEMP=temp

# –µ—Å—Ç—å —É –Ω–∞—Å ImageMagic?
MAGICSPLIT=

which -s convert
if [ $? -eq 0 ]; then

    # –ø—Ä–æ–≤–µ—Ä–∏–º, –ø—Ä–∏–≥–æ–¥–µ–Ω –ª–∏ –æ–Ω –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
    gif='R0lGODdhCgAKAPMJAODg/x8f/z4+/1BQ/2Bg/5+f/6+v/8HB/////wAA/wAAAAAAAAAAAA
    AAAAAAAAAAACwAAAAACgAKAAAEMBBJcERIWCJqcdLchQHkYQxWEBysURCoIMsDURjsoQbCg
    JMAD+8A0AgFRCNmWJREAAA7'

    no=$(echo $gif | base64 -D | convert +compress - - | wc -c)
    yes=$(echo $gif | base64 -D | convert - - | wc -c)

    if [ $yes -eq $no ]; then
        MAGICSPLIT=yes

        which -s gifinter
        if [ $? -eq 1 ]; then
            echo –û—à–∏–±–∫–∞: –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ gifinter –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ libungif
        fi
    else
        which -s gifsicle
        if [ $? -eq 1 ]; then
            echo –û—à–∏–±–∫–∞: –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ gifsicle
        fi
    fi
fi

# –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º
mkdir -p "$TEMP"
rm -f "$TEMP"/*

# –°–º–æ—Ç—Ä–∏–º –∫–∞–∫–æ–π –ü–∞–π—Ç–æ–Ω —É –Ω–∞—Å –≤ –Ω–∞–ª–∏—á–∏–∏
which -s pypy
if [ $? -eq 1 ]; then
    which -s python

    if [ $? -eq 1 ]; then
        echo "–û—à–∏–±–∫–∞: –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω—É–∂–µ–Ω python –∏–ª–∏ PyPy."
        exit 1
    fi
    PYTHON=python
else
    PYTHON=pypy
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
"$PYTHON" gifreadstructure.py "$1" > "$TEMP"/structure.cfg &
echo –°–∫–∞–Ω–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É

if [ -z "$MAGICSPLIT" ]; then
    echo –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –∫–∞–¥—Ä—ã —É—Ç–∏–ª–∏—Ç–æ–π gifsicle

    gifsicle -e -o "$TEMP"/frame "$1" 2>/dev/null &
    wait
else
    wait

    echo –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –∫–∞–¥—Ä—ã –ø—Ä–∏ –ø–æ–º–æ—â–∏ ImageMagic

    # —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∫–∞–¥—Ä–æ–≤?
    FRAMES=$(grep -F 'block_id = 44' "$TEMP"/structure.cfg | wc -l)
    let 'FRAMES--'

    # –ø—É—Å–∫–∞–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é –≤ —Ñ–æ–Ω–µ
    proc=0
    for n in `seq 0 $FRAMES`; do
        convert "${1}[${n}]" $(printf "%s/%s%03d" "$TEMP" frame. $n) &

        let 'proc++'

        if [ $proc -gt 5 ]; then
            wait
            proc=0
        fi
    done

    wait
fi

echo –ü–æ–ª—É—á–∏–ª–æ—Å—å –∫–∞–¥—Ä–æ–≤: $(ls -1 "$TEMP"/frame.* | wc -l)
echo –ü–µ—Ä–µ–ø–∞–∫–æ–≤–∫–∞ –∫–∞–¥—Ä–æ–≤ —É—Ç–∏–ª–∏—Ç–æ–π gifinter

proc=0

for name in "$TEMP"/frame.*; do
    (
        gifinter "$name" |
        "$PYTHON" gifreadstructure.py --body=1 - > "$TEMP/${name##*.}.raw"
        rm -f "$name"
    ) &
    let 'proc++'

    if [ $proc -gt 5 ]; then
        wait
        proc=0
    fi
done

wait

echo –°–±–æ—Ä–∫–∞ –∏ —Å–∂–∞—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
"$PYTHON" gifwritestructure.py "$TEMP" | gzip -9ncf > "$2"
rm -rf "$TEMP"

echo –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–Ω–∏–º–∞–µ—Ç $(ls -hl "$2" | awk '{print $5}'), –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª $(ls -hl "$1" | awk '{print $5}')

newsize=$(ls -l "$2" | awk '{print $5}')
origsize=$(ls -l "$1" | awk '{print $5}')

let 'diff=origsize-newsize'

case $diff in
    0  )
        echo –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è;;
    -* )
        let 'diff=-diff'
        echo 'üëé  –ü—Ä–æ–∏–≥—Ä—ã—à:' $diff –±–∞–π—Ç;;
    *  )
        echo 'üëç  –í—ã–∏–≥—Ä—ã—à:' $diff –±–∞–π—Ç;;
esac


